#!/usr/bin/env python

import rospy
import smach
import smach_ros


from daedalus_core.pcs_states import *


class Mission_SM:
    def __init__(self):

        # Create a SMACH state machine
        self.sm = smach.StateMachine(outcomes=["Mission_Success", "Mission_Fail"])

        self.mission_sm()

    
    def mission_sm(self):
        with self.sm:

            #example states
            
            smach.StateMachine.add('Init_Arm_sync', ARM_Sync('init', timeout=60),
                transitions={'Ready': 'Pickup_Cube',
                             'Timeout': 'Mission_Fail'})
            

            smach.StateMachine.add('Pickup_Cube', Pickup_Cube_SM,
                    transitions={'Success': 'Unfold',
                                 'Fail': 'Mission_Fail'})

            smach.StateMachine.add('Unfold', Unfold_SM,
                    transitions={'Success': 'Mission_Success',
                                 'Fail': 'Mission_Fail'})





# states to follow the state machine

            smach.StateMachine.add('Init_Arms', init_arms(), transitions={'Success': 'Unfold_Arms', 'Fail': 'init'})

            smach.StateMachine.add('Unfold_Arms', unfold_SM, transitions={'Success': 'Pickup_Obj_1', 'Fail': 'init'})

# ball 1
            smach.StateMachine.add('Pickup_Obj_1', pickup_obj_1_SM, transitions={'Successs': 'Throw_1', 'Fail': 'Home_Pos_1'}) #done
            smach.StateMachine.add('Throw_1', throw_1_SM, transitions={'Else': 'Home_Pos_1'}) #done
            smach.StateMachine.add('Home_Pos_1', home_pos_1_SM, tranitions={'Pickup_Fail_1': 'Pickup_Obj_1', 'Move_On': 'Home_Pos_1', 'Catch_Flag': 'AI_Catch'})

# ball 2
            smach.StateMachine.add('AI_Catch', catch_SM, transitions={'Success': 'Discard', 'Fail': 'Home_Pos_2'})
            smach.StateMachine.add('Discard', discard_obj_SM, transitions={'Success': 'Home_Pos_2', 'Fail': 'Home_Pos_2'})
            smach.StateMachine.add('Home_Pos_2', home_pos_2_SM, tranitions={'Wait': 'Home_Pos_2', 'Move_On': 'Pickup_Obj_3'})

# cube 1
            smach.StateMachine.add('Pickup_Obj_3', pickup_obj_3_SM, transitions={'Success': 'Throw_3', 'Fail': 'Home_Pos_3'})
            smach.StateMachine.add('Throw_3', throw_3_SM, transitions={'Else': 'Home_pos_3'})
            smach.StateMachine.add('Home_Pos_3', home_pos_3_SM, transitions={'Pickup_Fail_3': 'Pickup_Obj_3', 'Done': 'Fold_Arms', 'Else': 'Home_Pos_3'})

# done
            smach.stateMachine.add('Fold_Arms', fold_SM, transitions={'Success': 'Deinit', 'Fail': 'Fold_Arms'})
            smach.StateMachine.add('Deinit', deinit_SM, transitions={'Else': 'Deinit'})


    def run(self):
        folding = rospy.get_param('joints/folding')
        print(len(folding))
        outcome = self.sm.execute()


if __name__ == "__main__":
    rospy.init_node("mission_sm")
    sm = Mission_SM()
    sm.run()